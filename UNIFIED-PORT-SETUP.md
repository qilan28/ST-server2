# ç»Ÿä¸€ç«¯å£æ¶æ„éƒ¨ç½²æŒ‡å—

è¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„nginxé…ç½®æ–¹æ¡ˆï¼Œ**åªä½¿ç”¨ä¸€ä¸ª3000ç«¯å£**æ¥å¤„ç†æ‰€æœ‰è¯·æ±‚ï¼ŒåŒ…æ‹¬ç®¡ç†å¹³å°å’Œç”¨æˆ·å®ä¾‹è½¬å‘ã€‚

## ğŸ¯ æ¶æ„å¯¹æ¯”

### åŸå§‹æ¶æ„ï¼ˆå¤æ‚ï¼‰
```
å¤–éƒ¨è®¿é—® â†’ Nginx (80ç«¯å£) â”¬â†’ ç®¡ç†å¹³å° (3000ç«¯å£)
                       â”œâ†’ ç”¨æˆ·1å®ä¾‹ (3001ç«¯å£)
                       â”œâ†’ ç”¨æˆ·2å®ä¾‹ (3002ç«¯å£)
                       â””â†’ ...æ›´å¤šç«¯å£
```

### æ–°æ¶æ„ï¼ˆç®€åŒ–ï¼‰
```
å¤–éƒ¨è®¿é—® â†’ Nginx (80ç«¯å£) â†’ ExpressæœåŠ¡å™¨ (3000ç«¯å£)
                            â”œâ†’ ç®¡ç†å¹³å°è·¯ç”±
                            â””â†’ å®ä¾‹ä»£ç†è·¯ç”± â†’ å†…éƒ¨è½¬å‘
```

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. å®‰è£…ä¾èµ–

```bash
# å®‰è£…ä»£ç†ä¸­é—´ä»¶
npm install http-proxy-middleware
```

### 2. ç”Ÿæˆæ–°çš„nginxé…ç½®

```bash
# ç”Ÿæˆç»Ÿä¸€ç«¯å£çš„nginxé…ç½®
npm run generate-unified-nginx

# è¿™ä¼šç”Ÿæˆ nginx/nginx-unified.conf æ–‡ä»¶
```

### 3. éƒ¨ç½²nginxé…ç½®

**Ubuntu/Debian:**
```bash
# å¤‡ä»½ç°æœ‰é…ç½®
sudo cp /etc/nginx/sites-enabled/sillytavern /etc/nginx/sites-available/sillytavern.backup

# éƒ¨ç½²æ–°é…ç½®
sudo cp nginx/nginx-unified.conf /etc/nginx/sites-available/sillytavern-unified
sudo ln -sf /etc/nginx/sites-available/sillytavern-unified /etc/nginx/sites-enabled/sillytavern

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡è½½é…ç½®
sudo systemctl reload nginx
```

**CentOS/RHEL:**
```bash
# å¤‡ä»½ç°æœ‰é…ç½®
sudo cp /etc/nginx/conf.d/sillytavern.conf /etc/nginx/conf.d/sillytavern.conf.backup

# éƒ¨ç½²æ–°é…ç½®
sudo cp nginx/nginx-unified.conf /etc/nginx/conf.d/sillytavern-unified.conf

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡è½½é…ç½®
sudo systemctl reload nginx
```

### 4. é‡å¯ExpressæœåŠ¡å™¨

```bash
# é‡å¯æœåŠ¡å™¨ä»¥åŠ è½½æ–°çš„ä»£ç†è·¯ç”±
npm start
```

## âœ… éªŒè¯éƒ¨ç½²

éƒ¨ç½²å®Œæˆåï¼Œè®¿é—®ä»¥ä¸‹åœ°å€éªŒè¯ï¼š

1. **ç®¡ç†å¹³å°**: `http://ä½ çš„åŸŸå/`
2. **ç”¨æˆ·å®ä¾‹**: `http://ä½ çš„åŸŸå/ç”¨æˆ·å/st/`
3. **APIæ¥å£**: `http://ä½ çš„åŸŸå/api/health`

## ğŸ“‹ ä¼˜åŠ¿å¯¹æ¯”

| ç‰¹æ€§ | åŸå§‹æ¶æ„ | ç»Ÿä¸€ç«¯å£æ¶æ„ |
|------|----------|--------------|
| nginxå¤æ‚åº¦ | é«˜ï¼ˆéœ€è¦ä¸ºæ¯ä¸ªç”¨æˆ·é…ç½®upstreamï¼‰ | ä½ï¼ˆåªæœ‰ä¸€ä¸ªupstreamï¼‰ |
| ç«¯å£ç®¡ç† | å¤æ‚ï¼ˆéœ€è¦ç®¡ç†å¤šä¸ªç«¯å£ï¼‰ | ç®€å•ï¼ˆåªæœ‰3000ç«¯å£ï¼‰ |
| é…ç½®ç”Ÿæˆ | å¤æ‚ï¼ˆéœ€è¦åŠ¨æ€ç”Ÿæˆå¤šä¸ªlocationï¼‰ | ç®€å•ï¼ˆé™æ€é…ç½®ï¼‰ |
| è·¯ç”±å¤„ç† | nginxå¤„ç† | Expresså¤„ç†ï¼ˆæ›´çµæ´»ï¼‰ |
| è°ƒè¯•éš¾åº¦ | å›°éš¾ï¼ˆå¤šå±‚è½¬å‘ï¼‰ | ç®€å•ï¼ˆé›†ä¸­å¤„ç†ï¼‰ |
| æ‰©å±•æ€§ | ä¸­ç­‰ | é«˜ï¼ˆå¯ä»¥åœ¨Expressä¸­æ·»åŠ æ›´å¤šé€»è¾‘ï¼‰ |

## ğŸ”§ å·¥ä½œåŸç†

### è¯·æ±‚æµç¨‹

1. **å¤–éƒ¨è¯·æ±‚** â†’ `http://domain/user1/st/api/chat`
2. **nginxè½¬å‘** â†’ `http://127.0.0.1:3000/user1/st/api/chat`
3. **Expressè·¯ç”±åŒ¹é…** â†’ `/:username/st*` è·¯ç”±
4. **ä»£ç†ä¸­é—´ä»¶å¤„ç†** â†’ æå–ç”¨æˆ·å`user1`ï¼ŒæŸ¥æ‰¾ç”¨æˆ·ç«¯å£
5. **å†…éƒ¨è½¬å‘** â†’ `http://127.0.0.1:3001/api/chat`ï¼ˆç§»é™¤å‰ç¼€ï¼‰

### è·¯å¾„é‡å†™ç¤ºä¾‹

| å¤–éƒ¨è¯·æ±‚ | nginxè½¬å‘ | Expresså¤„ç† | æœ€ç»ˆè½¬å‘ |
|----------|-----------|-------------|----------|
| `/user1/st/` | â†’ `3000ç«¯å£` | è¯†åˆ«ç”¨æˆ·`user1` | â†’ `3001ç«¯å£/` |
| `/user1/st/api/chat` | â†’ `3000ç«¯å£` | è·¯å¾„é‡å†™ | â†’ `3001ç«¯å£/api/chat` |
| `/user1/st/css/style.css` | â†’ `3000ç«¯å£` | é™æ€èµ„æº | â†’ `3001ç«¯å£/css/style.css` |

## ğŸš¨ æ³¨æ„äº‹é¡¹

1. **ç¡®ä¿æ‰€æœ‰ç”¨æˆ·å®ä¾‹æ­£å¸¸è¿è¡Œ**
   - Expressä»£ç†ä¼šæ£€æŸ¥ç”¨æˆ·ç«¯å£æ˜¯å¦å¯ç”¨
   - å¦‚æœå®ä¾‹æœªè¿è¡Œä¼šè¿”å›502é”™è¯¯

2. **WebSocketæ”¯æŒ**
   - æ–°æ¶æ„å®Œå…¨æ”¯æŒWebSocket
   - SillyTavernçš„å®æ—¶åŠŸèƒ½æ­£å¸¸å·¥ä½œ

3. **å…¼å®¹æ€§**
   - ä¸ç°æœ‰åŠŸèƒ½å®Œå…¨å…¼å®¹
   - ç”¨æˆ·è®¿é—®æ–¹å¼ä¸å˜ï¼š`/ç”¨æˆ·å/st/`

4. **å›æ»šæ–¹æ¡ˆ**
   - å¦‚æœå‡ºç°é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿå›æ»šåˆ°åŸå§‹é…ç½®
   - å¤‡ä»½æ–‡ä»¶åœ¨`*.backup`

## ğŸ”„ å›æ»šåˆ°åŸå§‹æ¶æ„

å¦‚æœéœ€è¦å›æ»šåˆ°åŸå§‹çš„å¤šç«¯å£æ¶æ„ï¼š

```bash
# æ¢å¤åŸå§‹nginxé…ç½®
sudo cp /etc/nginx/sites-available/sillytavern.backup /etc/nginx/sites-enabled/sillytavern

# æˆ–è€…é‡æ–°ç”ŸæˆåŸå§‹é…ç½®
npm run generate-nginx

# é‡è½½nginx
sudo nginx -t && sudo systemctl reload nginx
```

## ğŸ“ æ•…éšœæ’é™¤

### 502 Bad Gatewayé”™è¯¯
- æ£€æŸ¥ExpressæœåŠ¡å™¨æ˜¯å¦åœ¨3000ç«¯å£è¿è¡Œ
- æ£€æŸ¥ç”¨æˆ·å®ä¾‹æ˜¯å¦æ­£å¸¸å¯åŠ¨
- æŸ¥çœ‹Expressæ—¥å¿—ï¼š`npm start`

### è·¯å¾„é”™è¯¯
- ç¡®ä¿è®¿é—®è·¯å¾„æ ¼å¼æ­£ç¡®ï¼š`/ç”¨æˆ·å/st/`
- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨ä¸”å·²åˆ†é…ç«¯å£

### WebSocketè¿æ¥å¤±è´¥
- ç¡®ä¿nginxé…ç½®ä¸­åŒ…å«`proxy_set_header Upgrade`ç­‰WebSocketå¤´
- æ£€æŸ¥é˜²ç«å¢™æ˜¯å¦é˜»æ­¢WebSocketè¿æ¥

éœ€è¦æŠ€æœ¯æ”¯æŒè¯·æŸ¥çœ‹æ—¥å¿—æˆ–è”ç³»ç®¡ç†å‘˜ã€‚
